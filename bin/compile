#!/usr/bin/env bash

# sample buildpack to install and configure ZooKeeper 3.4.5

set -eo pipefail

BIN_DIR=$(cd $(dirname $0); pwd)
ROOT_DIR=$(dirname $BIN_DIR)
BUILD_DIR=$1

# parse args
APP_BUILD_DIR=$(cd $1; pwd)
CACHE_DIR=$2
ENV_DIR=$3

echo "BIN_DIR = $BIN_DIR"
echo "BUILD_DIR = $BUILD_DIR"
echo "APP_BUILD_DIR = $APP_BUILD_DIR"
echo "CACHE_DIR = $CACHE_DIR"
echo "ENV_DIR = $ENV_DIR"

# The ROOT_DIR is read only so we can't install dependencies in it
# Move the ROOT_DIR contents to tmp and point ROOT_DIR to the new root
TMP_ROOT=/tmp/buildpack
rm -rf $TMP_ROOT
cp -r $ROOT_DIR $TMP_ROOT
ROOT_DIR=$TMP_ROOT
cd $ROOT_DIR


# Setting up the zooKeeper location within the app directory
zkDir="${BUILD_DIR}"/.zk
zkTarball="${zkDir}"/zk.tar.gz
zkUrl=http://apache.mirrors.tds.net/zookeeper/zookeeper-3.4.5/zookeeper-3.4.5.tar.gz
mkdir -p "${zkDir}"


echo "copying from the ZooKeeper download directory - http://apache.mirrors.tds.net/zookeeper/zookeeper-3.4.5/zookeeper-3.4.5.tar.gz "

#curl --silent --location http://apache.mirrors.tds.net/zookeeper/zookeeper-3.4.5/zookeeper-3.4.5.tar.gz | tar xz
curl --silent --location ${zkUrl} --output ${zkTarball}
tar pxzf ${zkTarball} -C "${zkDir}"
rm ${zkTarball}
echo "current directory location: $(pwd)" 
echo "directory of ZK buildpack: ${zkDir}"
echo "Files : $(ls ${zkDir})"

# Export Path Variables
#export ZOOKEEPER_INSTALL="${zkDir}/zookeeper-3.4.5"
#echo $ZOOKEEPER_INSTALL
#export PATH=$ZOOKEEPER_INSTALL/bin:$PATH
#echo $PATH
echo "============================ZooKeeper Buildpack EOP==============================="